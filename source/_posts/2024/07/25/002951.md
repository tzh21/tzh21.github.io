---
title: "Spring reactive web app: bodyToMono: JSON decoding error"
date: 2024-07-25 00:29:53
tags:
    - Spring
---

```kotlin
package org.example.springsecuritykotlin

import org.springframework.http.MediaType
import org.springframework.stereotype.Component
import org.springframework.web.reactive.function.BodyInserters
import org.springframework.web.reactive.function.server.ServerRequest
import org.springframework.web.reactive.function.server.ServerResponse
import reactor.core.publisher.Mono

@Component
class GreetingHandler {
    fun hello(request: ServerRequest?): Mono<ServerResponse> {
        return ServerResponse
            .ok().contentType(MediaType.APPLICATION_JSON)
            .body(BodyInserters.fromValue(GreetingResponse("Hello World!")))
    }

    fun greetingToName(request: ServerRequest): Mono<ServerResponse> {
        return request
            .bodyToMono(NameRequest::class.java)
            .flatMap { nameRequest ->
                val response = GreetingResponse("Hello, ${nameRequest.user}!")
                ServerResponse.ok().contentType(MediaType.APPLICATION_JSON)
                    .body(BodyInserters.fromValue(response))
            }
            .onErrorResume { exception ->
                println("Greeting error: ${exception.message}")
                exception.printStackTrace()
                ServerResponse.badRequest().contentType(MediaType.APPLICATION_JSON)
                    .body(BodyInserters.fromValue(mapOf("error" to "Invalid request", "details" to exception.message)))
            }
    }
}

data class GreetingResponse(val message: String)
data class NameRequest(val user: String)
```

报错 JSON decoding error

发现原因是 bodyToMono 不支持 data class 的解析。将 data 去掉即可。
